# 总体修改说明

本文件记录本轮针对“酿酒数字孪生系统”的前后端对齐、接口修复、性能优化与稳定性改进。

## 一、后端修改

### 1. 接口与协议对齐
- 补齐告警接口：新增 `GET /api/v1/alarms/active`，避免 `/alarms/{id}` 误解析。
- 兼容告警处理：
  - `PUT /alarms/{id}/resolve` 支持 query/body 两种参数来源。
  - 新增 `PUT /alarms/resolve-batch` 兼容前端批量处理入参。
- 生产接口兼容：
  - `PUT /production/batches/{id}/start` 与 `PUT /production/batches/{id}/complete` 补齐。
  - 新增生产统计、趋势、工艺参数与参数更新接口。
- Dashboard 接口：
  - `GET /dashboard/overview` 现在返回 `alarm_trend` 与 `production_progress` 结构。
- WebSocket：
  - 统一支持 `/ws/realtime` 与 `/ws/**`。
  - 允许跨域 `setAllowedOriginPatterns("*")`。

### 2. 性能优化
- 为 `pit_sensor_data` 与 `device_data` 增加索引（按设备/窖池 + 记录时间）。
- 使用原生查询获取“最新一条”数据，替代低效子查询。
- 定时清理历史数据（默认保留 24 小时），避免数据膨胀。

### 3. 其它
- H2 数据库改为文件模式，持久化演示数据。
- WebSocket 推送补充 `dashboard_update` 与 `alarm_update`，提高前端实时性。

## 二、前端修改

### 1. API 适配与稳定性
- Axios 统一解析后端 `ApiResponse`，直接返回 `data`。
- 开发环境直连后端：`http://localhost:8000/api/v1`，避免代理影响。
- 提高超时时间（10s → 30s）。
- Dashboard / PitMonitor 改为 `Promise.allSettled`，部分失败也能显示其他数据。

### 2. 字段映射统一
对齐后端字段命名：
- Dashboard：`totalPits`、`normalPits`、`activeAlarms` 等。
- PitMonitor：`pitNo`、`fermentationDay`、`row/col`、`phValue`、`recordedAt`。
- DeviceMonitor：`deviceNo`、`runningHours`、`lastMaintenance`、`recordedAt`。
- AlarmCenter / ProductionManage：字段全部与后端实体一致。

### 3. WebSocket 稳定性
- 统一连接 `/ws/realtime`。
- 避免 `onMessage` 引起的重复重连（使用 `ref` 缓存回调）。

### 4. UI 风格改造（夜间液态）
- 全局液态主题变量、玻璃卡组件样式与背景氛围。
- 布局与页面卡片统一液态玻璃风格。
- 图表颜色、网格与文字统一夜间主题。
- 移除日间模式（按需求回退至单一夜间模式）。

## 三、涉及的主要文件

- 后端：
  - `backend-java/src/main/java/com/brewery/digitaltwin/config/WebSocketConfig.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/config/WebConfig.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/DashboardService.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/SimulatorService.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/controller/AlarmController.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/controller/ProductionController.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/ProductionService.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/ProductionParam.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/entity/PitSensorData.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/entity/DeviceData.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/repository/PitSensorDataRepository.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/repository/DeviceDataRepository.java`
  - `backend-java/src/main/resources/application.yml`

- 前端：
  - `frontend/src/services/api.ts`
  - `frontend/src/hooks/useWebSocket.ts`
  - `frontend/src/index.css`
  - `frontend/src/layouts/MainLayout.tsx`
  - `frontend/src/pages/Dashboard.tsx`
  - `frontend/src/pages/PitMonitor.tsx`
  - `frontend/src/pages/DeviceMonitor.tsx`
  - `frontend/src/pages/AlarmCenter.tsx`
  - `frontend/src/pages/ProductionManage.tsx`
  - `frontend/src/pages/DigitalTwin.tsx`
  - `frontend/src/store/index.ts`

## 四、已知提示

- `antd` 的 `Card headStyle` 已废弃，仅为警告，不影响功能。
- 若本机启用系统代理，需将 `localhost/127.0.0.1` 加入代理绕过列表，否则会导致 API/WS 访问异常。
