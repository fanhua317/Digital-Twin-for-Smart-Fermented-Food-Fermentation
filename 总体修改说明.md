# 总体修改说明

本文件记录本轮针对“酿酒数字孪生系统”的前后端对齐、接口修复、性能优化与稳定性改进。

## 一、后端修改

### 1. 接口与协议对齐
- 补齐告警接口：新增 `GET /api/v1/alarms/active`，避免 `/alarms/{id}` 误解析。
- 兼容告警处理：
  - `PUT /alarms/{id}/resolve` 支持 query/body 两种参数来源。
  - 新增 `PUT /alarms/resolve-batch` 兼容前端批量处理入参。
- 生产接口兼容：
  - `PUT /production/batches/{id}/start` 与 `PUT /production/batches/{id}/complete` 补齐。
  - 新增生产统计、趋势、工艺参数与参数更新接口。
- Dashboard 接口：
  - `GET /dashboard/overview` 现在返回 `alarm_trend` 与 `production_progress` 结构。
- WebSocket：
  - 统一支持 `/ws/realtime` 与 `/ws/**`。
  - 允许跨域 `setAllowedOriginPatterns("*")`。

### 2. 性能优化
- 为 `pit_sensor_data` 与 `device_data` 增加索引（按设备/窖池 + 记录时间）。
- 使用原生查询获取“最新一条”数据，替代低效子查询。
- 定时清理历史数据（默认保留 24 小时），避免数据膨胀。

### 3. 其它
- H2 数据库改为文件模式，持久化演示数据。
- WebSocket 推送补充 `dashboard_update` 与 `alarm_update`，提高前端实时性。

## 二、前端修改

### 1. API 适配与稳定性
- Axios 统一解析后端 `ApiResponse`，直接返回 `data`。
- 开发环境直连后端：`http://localhost:8000/api/v1`，避免代理影响。
- 提高超时时间（10s → 30s）。
- Dashboard / PitMonitor 改为 `Promise.allSettled`，部分失败也能显示其他数据。

### 2. 字段映射统一
对齐后端字段命名：
- Dashboard：`totalPits`、`normalPits`、`activeAlarms` 等。
- PitMonitor：`pitNo`、`fermentationDay`、`row/col`、`phValue`、`recordedAt`。
- DeviceMonitor：`deviceNo`、`runningHours`、`lastMaintenance`、`recordedAt`。
- AlarmCenter / ProductionManage：字段全部与后端实体一致。

### 3. WebSocket 稳定性
- 统一连接 `/ws/realtime`。
- 避免 `onMessage` 引起的重复重连（使用 `ref` 缓存回调）。

### 4. UI 风格改造（夜间液态）
- 全局液态主题变量、玻璃卡组件样式与背景氛围。
- 布局与页面卡片统一液态玻璃风格。
- 图表颜色、网格与文字统一夜间主题。
- 移除日间模式（按需求回退至单一夜间模式）。

## 三、涉及的主要文件

- 后端：
  - `backend-java/src/main/java/com/brewery/digitaltwin/config/WebSocketConfig.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/config/WebConfig.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/DashboardService.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/SimulatorService.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/controller/AlarmController.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/controller/ProductionController.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/ProductionService.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/service/ProductionParam.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/entity/PitSensorData.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/entity/DeviceData.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/repository/PitSensorDataRepository.java`
  - `backend-java/src/main/java/com/brewery/digitaltwin/repository/DeviceDataRepository.java`
  - `backend-java/src/main/resources/application.yml`

- 前端：
  - `frontend/src/services/api.ts`
  - `frontend/src/hooks/useWebSocket.ts`
  - `frontend/src/index.css`
  - `frontend/src/layouts/MainLayout.tsx`
  - `frontend/src/pages/Dashboard.tsx`
  - `frontend/src/pages/PitMonitor.tsx`
  - `frontend/src/pages/DeviceMonitor.tsx`
  - `frontend/src/pages/AlarmCenter.tsx`
  - `frontend/src/pages/ProductionManage.tsx`
  - `frontend/src/pages/DigitalTwin.tsx`
  - `frontend/src/store/index.ts`

## 四、已知提示

- `antd` 的 `Card headStyle` 已废弃，仅为警告，不影响功能。
- 若本机启用系统代理，需将 `localhost/127.0.0.1` 加入代理绕过列表，否则会导致 API/WS 访问异常。

---

## 五、2026年1月2日 性能优化与问题修复

### 1. 严重性能问题修复

**问题描述**：窖池监控和综合监控中心页面加载数据非常慢（超过20秒），热力图API更是直接超时。

**根因分析**：
- 模拟器每5秒为100个窖池生成传感器数据
- 24小时会产生约 170万条记录
- `findLatestForAllPitsFast()` 查询在大数据量下仍然很慢
- `dashboard/stats` 和 `pits/heatmap` 都依赖这个慢查询

**优化方案**：

#### 后端优化 - 内存缓存机制

1. **DashboardService 新增热力图缓存**：
   ```java
   // 热力图缓存 - 由SimulatorService实时更新
   private final Map<Long, HeatmapData> heatmapCache = new ConcurrentHashMap<>();
   
   public void updateHeatmapCache(Long pitId, HeatmapData data) {
       heatmapCache.put(pitId, data);
   }
   ```

2. **getHeatmap() 优先使用缓存**：
   - 缓存非空时直接返回缓存数据
   - 首次加载生成默认数据并填充缓存
   - 避免每次请求都执行慢查询

3. **getStats() 使用缓存计算温湿度**：
   - 平均温度和湿度从热力图缓存中计算
   - 移除对 `findLatestForAllPitsFast()` 的依赖

4. **SimulatorService 实时更新缓存**：
   - 每次生成传感器数据时同步更新热力图缓存
   - 保证缓存数据与数据库实时同步

#### 前端优化 - 非阻塞加载

1. **PitMonitor.tsx**：
   - 将热力图改为独立异步加载 `loadHeatmapAsync()`
   - 主要数据（窖池列表、统计）先加载显示
   - 热力图后台加载，不阻塞页面渲染

2. **Dashboard.tsx**：
   - 将 overview 改为独立异步加载 `loadOverviewAsync()`
   - 核心统计数据先加载显示
   - 告警趋势等复杂数据后台加载

3. **api.ts**：
   - 超时时间从 30秒 缩短为 10秒
   - 避免用户长时间等待无响应

### 2. 性能提升效果

| API 端点 | 优化前 | 优化后 | 性能提升 |
|----------|--------|--------|----------|
| `/dashboard/stats` | ~20秒 | ~48ms | **400倍** |
| `/pits/heatmap` | >10秒(超时) | ~27ms | **370倍+** |
| `/pits` | ~86ms | ~57ms | 1.5倍 |
| `/pits/stats` | ~28ms | ~28ms | 持平 |

### 3. 数字孪生3D场景优化

**问题描述**：
- 车间概览页面进入时 AGV 车辆自动运行
- 仿真模拟未点击播放按钮就开始运行

**修复方案**：

1. **DigitalTwin.tsx**：
   - AGV 路径效果 `show` 属性改为 `false`（车间概览静态显示）
   - 仿真模拟标签页的动画由 `isSimulationRunning` 状态控制

2. **AGVModel.tsx**：
   - 修复 `status` prop 未正确使用的问题
   - 在 `useFrame` 中添加 `status !== 'active'` 检查
   - 确保只有激活状态的 AGV 才会移动

### 4. 本次修改涉及的文件

**后端**：
- `backend-java/src/main/java/com/brewery/digitaltwin/service/DashboardService.java`
  - 新增 `heatmapCache` 缓存机制
  - 新增 `updateHeatmapCache()` 方法
  - 优化 `getStats()` 和 `getHeatmap()` 方法

- `backend-java/src/main/java/com/brewery/digitaltwin/service/SimulatorService.java`
  - 在 `generatePitSensorData()` 中更新热力图缓存

**前端**：
- `frontend/src/pages/Dashboard.tsx`
  - 拆分为 `loadData()` + `loadOverviewAsync()`

- `frontend/src/pages/PitMonitor.tsx`
  - 拆分为 `loadData()` + `loadHeatmapAsync()`

- `frontend/src/services/api.ts`
  - 超时时间改为 10秒

- `frontend/src/pages/DigitalTwin.tsx`
  - AGV 路径效果默认关闭

- `frontend/src/components/3d/AGVModel.tsx`
  - 修复 status prop 使用问题

---

## 六、启动说明

### 快速启动

1. **启动后端**（独立窗口）：
   ```powershell
   cd backend-java
   mvn clean package -DskipTests
   java -jar target/digital-twin-1.0.0.jar
   ```

2. **启动前端**（独立窗口）：
   ```powershell
   cd frontend
   npm run dev
   ```

3. **访问系统**：
   - 前端：http://localhost:3000/
   - 后端 API：http://localhost:8000/api/v1/
   - H2 控制台：http://localhost:8000/h2-console

### 注意事项

- 首次启动时数据库会自动初始化100个窖池、50个设备的演示数据
- 模拟器每5秒生成新的传感器数据，保持系统动态运行
- 历史数据每小时清理一次，只保留最近24小时的记录
